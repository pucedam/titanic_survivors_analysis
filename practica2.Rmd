---
title: "Práctica 2: Limpieza y análisis de datos"
author: "Pedro Uceda Martínez, Pablo Campillo Sánchez"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(plyr)
library(dplyr)
library(gridExtra)
library(pROC)

```

# 1. Descripción del dataset

Durante esta práctica vamos a tratar el _dataset_ base de la competición [**Titanic - Machine Learning from Disaster**](https://www.kaggle.com/c/titanic/overview). En este conjunto de datos se nos presenta, para cada pasajero del tan famoso trasatlántico, sus datos personales más importantes, así como otros relacionados con su embarque en el Titanic, y si finalmente sobrevivieron al naufragio del mismo.

De este modo, este estudio es interesante dado que examinaremos qué posibles factores pudieron influir en la supervivencia de los pasajeros. Así, podremos, por ejemplo, ver si solamente la clase del billete, el género (mujeres) y la edad (niños) condicionaron que un viajero se salvase tal y como hemos visto en la gran pantalla o bien hubiera habido otros factores que pudieran haber determinado la supervivencia del pasajero, como el número de billete.

Las variables de las que disponemos, para cada pasajero, son:

- **PassengerId**: Identificador artifical del pasajero.
- **Survived**: Si sobrevivió (1) o no (0).
- **Pclass**: Clase del pasaje. 
- **Name**: Nombre del pasajero.
- **sex**: Sexo del viajero.
- **Age**: Edad, en años.
- **SibSp**: Número de hermanos o esposas a bordo del Titanic
- **Parch**: Número de padres / hijos a bordo del Titanic
- **ticket**: Número de ticket
- **fare**: Tarifa del pasaje
- **cabin**: Número de camarote
- **embarked**: Puerto desde el que embarcó el pasajero. Las posibles opciones son: Cherbourg(C), Queenstown(Q) o Southampton(s).

# 2. Integración y selección de los datos de interés a analizar.

Los datos a procesar provienen de una única fuente, por ello, no es necesario realizar la fase de integración o
fusionado de los datos. En este apartado, primero se cargarán los datos y se hará una exploración inicial de los mismos para
tener una idea más clara de los mismos y, posteriormente, se procede a seleccionar los datos de interés y a generar nuevas
características que puedan resultar interesantes para el análisis posterior.

## 2.1 Exploración de los datos (screening)

A continuación procedemos a cargar el __dataset__, sin __factors__, para evitar tratar los nombres de los pasajeros como tales.

```{r echo=TRUE, message=FALSE, warning=FALSE}
ds <- read.csv(file = "train.csv", header=TRUE, stringsAsFactors=FALSE)
str(ds)
```
Como se puede observar, el __dataset__ contiene 891 registros y 12 atributos. Tenemos las variables cuantitativas PassengerId, Survived, Pclass, Age, SibSp, Parch y Fare, todas tratadas como int o num. También están las variables cualitativas Ticket, PClass, Sex y  Cabin, cargadas como cadena de caracteres. Survived, aun siendo variable cuantitativa, representa 0 (no) y 1 (Yes), por lo que en realidad es una variable cualitativa dicotómica. Por cuestiones prácticas no la transformamos.

Para más claridad de los datos, procedemos a realizar las siguientes transformaciones:
- Transformamos el campo cualitativo categórico Embarked a un factor con 3 posibles valores, cada uno con el nombre del puerto.
- Transformamos el campo dicotómico Sex en vez de cadena.

```{r echo=TRUE, message=FALSE, warning=FALSE}
ds$Embarked <- factor(ds$Embarked, levels=sort(c("C", "Q", "S")), labels = c("Cherbourg", "Queenstown", "Southampton"))
ds$Sex <- factor(ds$Sex)
str(ds)
```

Para hacernos una idea de las características, vamos a mostrar las estadístcas básicas:

```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(ds)
```
La información más relevante es:

- **Survived**: Hay más gente que falleció que sobrevivió.
- **Pclass**: Lo más común es tercera clases (Median).
- **Sex**: En el barco viajaban el doble de hombres que de mujeres.
- **age**: especifica la edad en años. Podemos ver que el mínimo es 0.42 años, así que se contemplan bebés.
La persona más anciana tenía 80 años y la media de edad estaba en torno a los 30 años.
- **SibSp**: Lo más común es ir sin hermanos ni mujer.
- **Parch**: Es menos común todavía ir con descendientes o ascendientes.
- **Fare**: La media del precio del billete es 32.2 y la mediana 14. Esto indica que hay mucha disparidad de precios, siendo
el máximo 512.
- **Embarked**: La mayoría embarcaron de Southamption, luego de Cherbourg y unos pocos de Queenstown.

Por último, hacemos una inspección visual de los campos que menos sabemos sobre ellos: Ticket y Cabin.

La codificación del billete (Ticket) parece que sigue diferentes patrones y además, hay viajeros que comparten
el ticket ya que si los ordenamos, podemos comprobar que estos se repiten:

```{r echo=TRUE, message=FALSE, warning=FALSE}
sort(ds$Ticket)[1:10]
```
Si comprobamos los campos únicos, vemos que pasa de 891 a 681 valores diferentes.

```{r echo=TRUE, message=FALSE, warning=FALSE}
length(distinct(ds, Ticket)$Ticket)
```
Además, el que un ticket se repita no depende de su tipo:

```{r echo=TRUE, message=FALSE, warning=FALSE}
aux <- count(ds, Ticket)
aux[order(aux[,2], decreasing = TRUE), ][1:10, ]
```

Suponemos que se puede comprar un mismo billete para varias personas. ¿Compartirán el camarote? ¿Serán familia?
Veamos los datos de estos 10.

Ticket 1601:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "1601", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```

Ticket 347082:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "347082", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```

Ticket CA. 2343:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "CA. 2343", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```
Ticket 347088:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "347088", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```
Ticket 3101295:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "3101295", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```
Ticket 347088:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "347088", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```
Ticket CA 2144:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "CA 2144", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```
Ticket 382652:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "382652", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```

Ticket S.O.C. 14879:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "S.O.C. 14879", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```


```{r echo=TRUE, message=FALSE, warning=FALSE}
head(sort(distinct(ds, Ticket)$Ticket))
```

## 2.2 Selección y creación de características

__Los atributos PassengerId y Name no serán objeto de análisis__. 

 Nótese que Cabin es susceptible de ser dividida en letra y número.
 
 
## 2.1 Carga de los datos y selección



## 2.2 Transformación de los datos


A continuación analizamos cada uno de los distintos atributos:

```{r}

summary(ds)
```

Vemos que los campos Age y Embarked tienen 177 y 2 valores nulos, respectivamente. Como no tiene sentido interpretarlos como 0 años o ningún puerto, sustituimos estos campos por la mediana para que afecten en la medida de lo posible al análisis.

```{r}

age_median <- median(ds$Age, na.rm = TRUE)

ds[, 'Age'][is.na(ds[,'Age'])] <- age_median

embarked_most_frequent <-  levels(ds$Embarked)[which.max(ds$Embarked)]

ds[, 'Embarked'][is.na(ds[,'Embarked'])] <- embarked_most_frequent

summary(ds)


```


```{r}
#Visualización de variables cuantitativas

#Age
gAge1 <- ggplot(ds, aes(x=Age)) + geom_boxplot()

gAge2 <- ggplot(ds, aes(x=Age)) + geom_histogram(bins=20)

#SibSp

gSibSp1 <- ggplot(ds, aes(x=SibSp)) + geom_boxplot()

gSibSp2 <- ggplot(ds, aes(x=SibSp)) + geom_histogram(bins=20)

#Parch

gParch1 <- ggplot(ds, aes(x=Parch)) + geom_boxplot()

gParch2 <- ggplot(ds, aes(x=Parch)) + geom_histogram(bins=20)


#Fare

gFare1 <- ggplot(ds, aes(x=Fare)) + geom_boxplot()

gFare2 <- ggplot(ds, aes(x=Fare)) + geom_histogram(bins=20)


```


```{r}

grid.arrange(gAge1,gAge2,nrow=1)

grid.arrange(gSibSp1,gSibSp2,nrow=1)

grid.arrange(gParch1,gParch2,nrow=1)

grid.arrange(gFare1,gFare2,nrow=1)

```

```{r}

#Visualizacion de variables cuantitativas

#Survived
sumSurvived <- summarize( group_by(ds, Survived), n=length(Survived), Fare=mean(Fare))

gSurvived1 <- ggplot( sumSurvived, aes(x="", y=n, fill=Survived)) +
geom_bar(width = 1, stat = "identity") +
coord_polar("y", start=0) + ggtitle("Survived")

#PClass and Survived
sumPClass <- summarize( group_by(ds, Pclass), n=length(Pclass), Survived=mean(Survived))

gPClass1 <- ggplot( sumPClass, aes(x="", y=n, fill=Pclass)) +
geom_bar(width = 1, stat = "identity") +
coord_polar("y", start=0) + ggtitle("PClass")

gPClass2 <- ds %>%
  group_by(Survived, Pclass) %>%
  tally() %>%
  group_by(Survived) %>%
  mutate(x = n / sum(n)) %>%
  ggplot() +
    geom_col(aes(
      x = factor(Pclass),
      y = x,
      fill = factor(Survived)
      ), position = "stack")

#Sex and Survived
sumSex <- summarize( group_by(ds, Sex), n=length(Sex), Survived=mean(Survived))

gSex1 <- ggplot( sumSex, aes(x="", y=n, fill=Sex)) +
geom_bar(width = 1, stat = "identity") +
coord_polar("y", start=0) + ggtitle("Sex")

gSex2 <- ds %>%
  group_by(Survived, Sex) %>%
  tally() %>%
  group_by(Survived) %>%
  mutate(x = n / sum(n)) %>%
  ggplot() +
    geom_col(aes(
      x = factor(Sex),
      y = x,
      fill = factor(Survived)
      ), position = "stack")

#Embarked and Survived
sumEmbarked <- summarize( group_by(ds, Embarked), n=length(Embarked))

gEmbarked1 <- ggplot( sumEmbarked, aes(x="", y=n, fill=Embarked)) +
geom_bar(width = 1, stat = "identity") +
coord_polar("y", start=0) + ggtitle("Embarked")


gEmbarked2 <- ds %>%
  group_by(Survived, Embarked) %>%
  tally() %>%
  group_by(Survived) %>%
  mutate(x = n / sum(n)) %>%
  ggplot() +
    geom_col(aes(
      x = factor(Embarked),
      y = x,
      fill = factor(Survived)
      ), position = "stack")

```

```{r}

grid.arrange(gSurvived1, nrow=2)

grid.arrange(gPClass1,gPClass2, nrow=1)

grid.arrange(gSex1, gSex2, nrow=1)

grid.arrange(gEmbarked1, gEmbarked2, nrow=1)

```

#2.3 Descipción estadística descriptiva

TODO: Describir cómo se distribuyen los datos y como podría saltar a la vista correlaciones. Da idea del ejercicio 4.

#3. Limpieza de datos

## 3.1  Elementos vacíos

TODO: En el ejercicio 1 se ha pintado  el campo Age y el campo Embarked ya sin elementos vacíos. Traer aqui y pintar de nuevo, con un summary para demostrar que han desaparecido.


## 3.2 Identificación y tratamiento de valores extremos.

TODO: Explicar que hay valores extremos pero no podemos suponer que sean incorrectos (por ejemplo gente que tiene 8 hermanos o un billete que cuesta 500$). Poner ejemplos...


# 4. Análisis de los datos

Antes de proceder a ver qué grupos de datos queremos normalizar, vamos a ver qué datos son normales y cuáles no, de manera gráfica...

```{r}
par(mfrow=c(2,2))
for(i in 1:ncol(ds)) {
  if (is.numeric(ds[,i])){
    qqnorm(ds[,i],main = paste("Normal Q-Q Plot for ",colnames(ds)[i]))
    qqline(ds[,i],col="red")
    hist(ds[,i], 
      main=paste("Histogram for ", colnames(ds)[i]), 
      xlab=colnames(ds)[i], freq = FALSE)
  }
}


plot(ds[,c("Pclass", "Sex", "Age", "SibSp", "Parch", "Embarked")])
```

## 4.1 Selección de los grupos de datos que se quieren analizar / comparar.

A continuación, se nombran los distintos grupos de datos que nos parecen interesantes:

- Analizaremos si __los niños__, entendiendo como tales los pasajeros que tenían 16 años o menos, __tuvieron la misma probabilidad de sobrevivir que los adultos o, por el contrario, más__. Compararemos los dos subgrupos de viajeros para responder a la siguientes hipótesis, teniendo __Ps(X) como la probabilidad de supervivencia del subgrupo X__:

$$
  H_{0} : p_s(children) = p_s(adults)
$$
$$
  H_{1} : p_s(children) > p_s(adults)
$$


- Intentaremos __aproximar los datos__ utilizando __un modelo de regresión__. __Partiremos de la edad__, con la que habremos trabajado anteriormente, __y el sexo__, y veremos si podemos incluir una tercera variable que nos permita que mejore el comportamiento de nuestro modelo.

- <<Nos faltan 1>>


A continuación, creamos un dataset para los pasajeros que son niños y otro para los adultos. Utilizaremos tales dataset posteriormente para realizar el contraste de hipótesis.

```{r}

children_passengers <- ds[ds$Age <= 16,] 
adults_passengers <- ds[ds$Age > 16,] 

```

## 4.2. Comprobación de la normalidad y homogeneidad de la varianza

Comprobamos si el atributo Age de los pasajeros, objeto de nuestro análisis, sigue una distribución normal, utilizando el test de Shapiro-Wilk:

```{r}

shapiro.test(ds$Age)

```

Obtenemos un __p-palor muy pequeño, menor al nivel de significancia 0.05__, por lo que podemos rechazar la hipótesis nula del test y asumimos que __la variable Age no sigue una distribución normal__.

Dado que la variable Age no sigue una distirbución normal, utilizaremos el __test de Fligner-Killeen__ para comprobar la homocedasticidad de la variable:

```{r}
fligner.test(Age~Survived, data = ds)

```
Observamos que dado el p-value obtenido, menor que 0.05, no podemos rechazar la hipótesis nula y concluimos que __la variable Age presenta una distribución homogénea de la varianza__.

Asimismo comprobamos si ambos subgrupos que vamos a comparar tienen la misma varianza:
```{r}

var.test(children_passengers$Age, adults_passengers$Age)

```

Por el p-value obtenido, muy pequeño, y el ratio que nos devuelve el test concluimos que __la varianza no es la misma para los dos grupos de supervivientes__ (niños y adultos).

# 4.3. Aplicación de pruebas estadísticas para comparar los grupos de datos

## 4.3.1 Supervivencia de niños vs adultos

Aunque la variable Age presente una distribución de la varianza homogénea, no tiene una distribución normal, por lo que no podemos utilizar tests pamétricos para comparar ambos grupos de datos. Utilizaremos pues el __test de Wilcox, no paramétrico, para comprobar si los niños sobrevivieron  más que los adultos__.

```{r}
  
  wilcox.test(children_passengers$Age, adults_passengers$Age, alternative = "greater")


```
Como vemos por el p-value con valor 1, el test nos arroja de manera decisiva que __los niños__ (primer grupo) __sobrevivieron mucho más que los adultos__ (segundo grupo).

A modo de comprobación, comprobamos que mediante la utilización del test obtenemos que para la hipotesis nula contraria:

```{r}
  
  wilcox.test(children_passengers$Age, adults_passengers$Age, alternative = "less")


```

En este caso el test nos arroja un valor p muy pequeño, lo que nos permite rechazar la hipotesis nula, si la hiciesemos, de que los niños sobrevivieron significiamente menos que los adultos.


## 4.3.2 Modelo de regresión

Como hemos comentado en el apartado 4.1, comenzaremos a construir nuestro modelo de regresion con los atributos Age y Sex. Dado que la variable __Survived es una variable cualitativa categórica__, utilizamos un __modelo de regresión logística__ en detrimento del lineal, ya que el rendimiento del primero es mejor en este caso.

Procedemos construir este primer modelo y ver cómo se comporta:

```{r}

model.logist1 = glm(formula = Survived ~ Age + Sex, family=binomial(link=logit), data = ds)

summary(model.logist1)


```

Vemos por el estadístico de Wald que la variable __Sex (p-value<0.05) sí es estadísticamente significativa, pero Age (p-value>0.05) no__. Por lo tanto, procedemos a __quitar la variable Age del modelo__.

Del ___data screaning___ observamos que el __Pclass parecía tener relación con la supervivencia__, puesto que los pasajeros de primera y segunda clase sobrevivieron mucho más que los de tercera. Procedemos a __incluirlo en el modelo en detrimento del atributo Age__ y vemos también el rendimiento del nuevo modelo:

```{r}

model.logist2.formula = Survived ~ Sex + Pclass

model.logist2 = glm(formula = model.logist2.formula, family=binomial(link=logit), data = ds)

summary(model.logist2)

```

Podemos observar que la variable __Pclass es estadísticamente significativa__ y vemos que __el modelo mejora, ya que el Akaike Information Criterion (AIC) es menor que en el primer modelo__ que realizamos.

Probamos a incluir también la variable SibSp en el modelo, ya que de manera intutiva tiene sentido que los hombres que viajasen solos sobreviviesen más que los que viajasen con esposa.

```{r}

model.logist3.formula = Survived ~ Sex + Pclass + SibSp

model.logist3 = glm(formula = model.logist3.formula, family=binomial(link=logit), data = ds)

summary(model.logist3)


```

Vemos que __SibSp también es estadísticamente significativa y que mejora un poco el rendimiento del algoritmo__.

Probamos a incorportar del mismo modo la variable Parch:

```{r}

model.logist4 = glm(formula = Survived ~ Sex + Pclass + SibSp + Parch, family=binomial(link=logit), data = ds)

summary(model.logist4)


```

Vemos que __la variable Parch no es estadísticamente significativa__, ya que su estadístico de Wald es mayor que 0.05, por lo que __la descartamos__. Comprobamos por último si el precio que pagó cada pasajero por el ticket mejoraría el modelo:

```{r}

model.logist5 = glm(formula = Survived ~ Sex + Pclass + SibSp + Fare, family=binomial(link=logit), data = ds)

summary(model.logist5)


```

Podemos observar que __la variable Fare tampoco es estadísticamente significativa, por lo que también la eliminamos del modelo__.


Tras este proceso, podemos concluir que __el mejor modelo logístico que explica la variable Survived es nuestro tercer modelo__, que utiliza Age , Pclass y SibSp para explicar la variable Survived:

$$
  Survived = exp(3.43 -2.74*Sexmale -0.93*Pclass - 0.24*SibSp)
$$

# 5. Representación de los resultados a partir de tablas y gráficas

## 5.1 Comparación entre menores de 16 años y mayores de 16 años

En el apartado anterior, hemos visto que __los niños sobrevivieron mucho más que los adultos__. Podemoso __visualizar__ esto de manera gráfica:

```{r}

#Calculamos la media para los dos tipos de pasajeros y lo pintamos en un diagrama de barras

children_passengers$Survived <-as.integer(children_passengers$Survived)
adults_passengers$Survived <- as.integer(adults_passengers$Survived)

mean_children_passengers <- mean(children_passengers$Survived)
mean_adults_passengers <- mean(adults_passengers$Survived)

#Print it
barplot(c(mean_children_passengers, mean_adults_passengers), names =c("Niños", "No niños (>16 años)"), main=("Media de supervivencia de los viajeros"), xlab="Edad")
```

Podemos ver también __cómo se distribuye la supervivencia, agrupando los pasajeros por edades__:

```{r}
#Agrupamos por tramos de edad
ds$AgeGroup <- cut(ds$Age, breaks=c(0,4,8,12,16,20,24,30,40,50,60,70,80))

#Pintamos AgeGroup and Survived
sumAgeGroup <- summarize( group_by(ds, AgeGroup), n=length(AgeGroup))


gAgeGroup1 <- ds %>%
group_by(Survived, AgeGroup) %>%
tally() %>%
group_by(Survived) %>%
mutate(x = n / sum(n)) %>%
ggplot() +
geom_col(aes(
x = factor(AgeGroup),
y = x,
fill = factor(Survived)
), position = "stack")

grid.arrange(gAgeGroup1, nrow=1)
```

Puede verse que __para los pasajeros con 16 años o menos la supervivencia es significativamente mayor, con la excepción del rango de edad de 4 a 8 años__. Por lo tanto, la supervivencia de los niños es mayor, pero tiene __más dispersión que la de los adultos__.

## 5.2 Modelo de regresión logística

Vemos los coeficiented del modelo que hemos dado como mejor (el tercero) para ver cómo se comportan las variables que lo explican:

```{r}
exp(coefficients(model.logist3))


##IC 
exp(confint(model.logist3))

```

La variable Sex tiene un OR de 0.064, la Pclass un OR de 0.39 y la SibSp un 0.78, por lo que a la hora de explicar la variable Survived sorprendentemente tiene mucho más peso la variable SibSp que el sexo o la clase, si bien tiene un Intervalo de Confianza, con una confianza del 95%, más amplio que las otras dos variables.


Procedemos a ver cómo se comportaría nuestro modelo de regresión logística a clase y SibSp constante y distinto sexo:

```{r}

#Males
new_passengers_male <- data.frame(
  Sex = rep("male", times = 3),
  Pclass = c(1,2,3),
  SibSp = c(1,1,1)
)

#Females
new_passengers_female <- data.frame(
  Sex = rep("female", times = 3),
  Pclass = c(1,2,3),
  SibSp = c(1,1,1)
)

prob_males <- predict(model.logist3, newdata = new_passengers_male, type="response")

prob_females <- predict(model.logist3, newdata = new_passengers_female, type="response")

prob_males

prob_females

plot(c(1,2,3), prob_females, type = "b", frame = FALSE, pch = 19, col = "pink", xlab = "Pclass", ylab = "prob Survived", ylim = c(0,1))

lines(c(1,2,3), prob_males, pch = 19, col = "blue", type = "b")

legend("topright", legend=c(" Mujeres", "Hombres"), col=c("pink", "blue"), lty = c(1,1), cex=0.8)


```

Ahora con clase y SibSps constantes y distinto sexo:

```{r}
new_passengers_class_1 <- data.frame(
  Sex = c("male", "female"),
  Pclass = c(1,1),
  SibSp = c(1,1)
)

new_passengers_class_2 <- data.frame(
  Sex = c("male", "female"),
  Pclass = c(2,2),
  SibSp = c(1,1)
)

new_passengers_class_3 <- data.frame(
  Sex = c("male", "female"),
  Pclass = c(3,3),
  SibSp = c(1,1)
)

prob_1 <- predict(model.logist3, newdata = new_passengers_class_1, type="response")

prob_2 <- predict(model.logist3, newdata = new_passengers_class_2, type="response")

prob_3 <- predict(model.logist3, newdata = new_passengers_class_3, type="response")

plot(c(1, 2), prob_1, type = "b", frame = FALSE, pch = 19, col = "red", xlab = "Sex", ylab = "prob Survived", ylim = c(0,1))

lines(c(1, 2), prob_2, pch = 19, col = "green", type = "b")

lines(c(1, 2), prob_3, pch = 19, col = "blue", type = "b")

legend("topright", legend=c(" Primera clase", "Segunda clase", "Tercera clase"), col=c("red", "green", "blue"), lty = c(1,1), cex=0.8)


```


Por último, solamente variaremos el SibSp. En el caso de los hombres:

```{r}
new_passengers_class_1 <- data.frame(
  Sex = rep("male", times = 10),
  Pclass = rep(1, times = 10),
  SibSp = 1:10
)

new_passengers_class_2 <- data.frame(
  Sex = rep("male", times = 10),
  Pclass = rep(c(2), times = 10),
  SibSp = 1:10
)

new_passengers_class_3 <- data.frame(
  Sex = rep("male", times = 10),
  Pclass = rep(3, times = 10),
  SibSp = 1:10
)

prob_1 <- predict(model.logist3, newdata = new_passengers_class_1, type="response")

prob_2 <- predict(model.logist3, newdata = new_passengers_class_2, type="response")

prob_3 <- predict(model.logist3, newdata = new_passengers_class_3, type="response")

plot(c(1:10), prob_1, type = "b", frame = FALSE, pch = 19, col = "red", xlab = "SibSp", ylab = "prob Survived", ylim = c(0,1))

lines(c(1:10), prob_2, pch = 19, col = "green", type = "b")

lines(c(1:10), prob_3, pch = 19, col = "blue", type = "b")

legend("topright", legend=c(" Primera clase", "Segunda clase", "Tercera clase"), col=c("red", "green", "blue"), lty = c(1,1), cex=0.8)

```

Y en el de las mujeres:

```{r}
new_passengers_class_1 <- data.frame(
  Sex = rep("female", times = 10),
  Pclass = rep(1, times = 10),
  SibSp = 1:10
)

new_passengers_class_2 <- data.frame(
  Sex = rep("female", times = 10),
  Pclass = rep(c(2), times = 10),
  SibSp = 1:10
)

new_passengers_class_3 <- data.frame(
  Sex = rep("female", times = 10),
  Pclass = rep(3, times = 10),
  SibSp = 1:10
)

prob_1 <- predict(model.logist3, newdata = new_passengers_class_1, type="response")

prob_2 <- predict(model.logist3, newdata = new_passengers_class_2, type="response")

prob_3 <- predict(model.logist3, newdata = new_passengers_class_3, type="response")

plot(c(1:10), prob_1, type = "b", frame = FALSE, pch = 19, col = "red", xlab = "SibSp", ylab = "prob Survived", ylim = c(0,1))

lines(c(1:10), prob_2, pch = 19, col = "green", type = "b")

lines(c(1:10), prob_3, pch = 19, col = "blue", type = "b")

legend("topright", legend=c(" Primera clase", "Segunda clase", "Tercera clase"), col=c("red", "green", "blue"), lty = c(1,1), cex=0.8)

```


Vemos cómo se comporta nuestro modelo: 

```{r}

model=model.logist3

prob=predict(model, ds, type="response")

r=roc(ds$Survived,prob, data=ds)

plot (r)

auc(r)

```

Vemos que el __área bajo la curva es de  0.8328, por lo que la capacidad de predicción de nuestro modelo es bastante buena__. Procedemos a calcular la sensibilidad y la especifidad.

```{r}

calculate_sensibility <- function(confusion_matrix){
  if(ncol(confusion_matrix) != 2) return(0)
  
  yes_yes <- confusion_matrix[2,2]
  yes_no <- confusion_matrix[1,2]
  
  sensibility <- yes_yes / (yes_yes + yes_no)
  
  return(sensibility)
}

calculate_specifity <- function(confusion_matrix){
  if(ncol(confusion_matrix) != 2) return(0)
  
  no_no <- confusion_matrix[1,1]
  no_yes <- confusion_matrix[2,1]
  
  specifity <- no_no / (no_no + no_yes)
  
  return(specifity)
}


calculate_global_accuracy <- function(confusion_matrix){
  if(ncol(confusion_matrix) != 2) return(0)
  
  yes_yes <- confusion_matrix[2,2]
  yes_no <- confusion_matrix[1,2]
  no_no <- confusion_matrix[1,1]
  no_yes <- confusion_matrix[2,1]
  
  ok_results <- yes_yes + no_no
  ko_results <- yes_no + no_yes
  
  ok_results / (ok_results + ko_results)
}


calculate_confusion_matrix <- function(model, data, real_values, threshold){
  predictions <- ifelse(predict(model, newdata = data, type="response")<threshold, "No","Yes")
  
  table(real_values, predictions, dnn = c("Valor Real","Valor Predicho"))
}

```

A continuación, observamos a ver cómo evoluciona la calidad (sensibilidad, especifidad y calidad total) cambiando el umbral según el cual aceptaremos que nuestro modelo predice si un viajero se salvó o no:
```{r}

calculate_quality_params <- function(model, data, real_values, threshold){

confusion_matrix <- calculate_confusion_matrix(model, data, real_values, threshold)

specifity <- calculate_specifity(confusion_matrix)

sensibility <- calculate_sensibility(confusion_matrix)

global_accuracy <- calculate_global_accuracy(confusion_matrix)

list("threshold" = threshold, "confusion_matrix" = confusion_matrix, "specifity" = specifity, "sensibility" = sensibility, "global accuracy" = global_accuracy)
}

quality_params_06 <- calculate_quality_params(model.logist3, ds, ds$Survived, 0.6)

quality_params_07 <- calculate_quality_params(model.logist3, ds, ds$Survived, 0.7)

quality_params_08 <- calculate_quality_params(model.logist3, ds, ds$Survived, 0.8)

quality_params_85 <- calculate_quality_params(model.logist3, ds, ds$Survived, 0.85)

quality_params_09 <- calculate_quality_params(model.logist3, ds, ds$Survived, 0.9)

quality_params_06
quality_params_07
quality_params_08
quality_params_85
quality_params_09

```

Vemos que __con un umbral del 0.6, obtenemos una gran sensibilidad (83%) sin comprometer la calidad total (80%)__ por lo que __la calidad de nuestro modelo es bastante aceptable__.


# 6. Resolución del problema. A partir de los resultados obtenidos, ¿cuáles son las conclusiones? ¿Los resultados permiten responder al problema?

En primer lugar nos hemos preguntado si los niños sobrevivieron más que los adultos, __comparando el atributo Age entre estas dos subpoblaciones__. Si bien la variable Age no sigue una distribución normal y no podemos explicar el comportamiento de la variable Survived a partir de ella, sí __hemos concluído, con un 95% de confianza, que los niños sobrevivieron mucho más que los adultos__. Asimismo, la supervivencia de los niños está mucho más dispersa que la de los adultos.

Posteriormente, hemos construído un modelo de regresión lineal logística que explica la variable Survived con bastante calidad. El modelo es el siguiente:

$$
  Survived = exp(3.43 -2.74*Sexmale -0.93*Pclass - 0.24*SibSp)
$$
A través del modelo mismo y de las gráficas de predicciones del mismo, hemos descubierto que:

- Aunque los niños sobreviviesen mucho más que los adultos, __no podemos establecer un modelo que explique la variable Survived con el atributo Age__.

- En general, __los hombres tienen muchas menos probabilidades de sobrevivir que las mujeres__.

- __La clase también tiene un papel fundamental__. Sin importar esposa o hermanos, __un hombre de tercera clase _a priori_ tiene muy pocas probabilidades de haber sobrevivido__.

- Sorprendentemente, __la variable SibSp es la que más peso tiene__. __A partir de 6 hermanos / esposa un hombre, independientemente de su clase, tiene muy pocas probabilidades de sobrevivir__. Podemos observar también cómo __en las mujeres este efecto es menos acusado__, y que una mujer de primera clase, incluso yendo con muchos hermanos, sí tenía mucha más probabilidad de sobrevivir que un hombre.





