---
title: "Práctica 2: Limpieza y análisis de datos"
author: "Pedro Uceda Martínez, Pablo Campillo Sánchez"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(plyr)
library(dplyr)
library(gridExtra)
library(pROC)

```

# 1. Descripción del dataset

Durante esta práctica vamos a tratar el _dataset_ base de la competición [**Titanic - Machine Learning from Disaster**](https://www.kaggle.com/c/titanic/overview). En este conjunto de datos se nos presenta, para cada pasajero del tan famoso trasatlántico, sus datos personales más importantes, así como otros relacionados con su embarque en el Titanic, y si finalmente sobrevivieron al naufragio del mismo.

De este modo, este estudio es interesante dado que examinaremos qué posibles factores pudieron influir en la supervivencia de los pasajeros. Así, podremos, por ejemplo, ver si solamente la clase del billete, el género (mujeres) y la edad (niños) condicionaron que un viajero se salvase tal y como hemos visto en la gran pantalla o bien hubiera habido otros factores que pudieran haber determinado la supervivencia del pasajero, como el número de billete.

Las variables de las que disponemos, para cada pasajero, son:

- **PassengerId**: Identificador artifical del pasajero.
- **Survived**: Si sobrevivió (1) o no (0).
- **Pclass**: Clase del pasaje. 
- **Name**: Nombre del pasajero.
- **sex**: Sexo del viajero.
- **Age**: Edad, en años.
- **SibSp**: Número de hermanos o esposas a bordo del Titanic
- **Parch**: Número de padres / hijos a bordo del Titanic
- **ticket**: Número de ticket
- **fare**: Tarifa del pasaje
- **cabin**: Número de camarote
- **embarked**: Puerto desde el que embarcó el pasajero. Las posibles opciones son: Cherbourg(C), Queenstown(Q) o Southampton(s).

# 2. Integración y selección de los datos de interés a analizar.

Los datos a procesar provienen de una única fuente, por ello, no es necesario realizar la fase de integración o
fusionado de los datos. En este apartado, primero se cargarán los datos y se hará una exploración inicial de los mismos para
tener una idea más clara de los mismos y, posteriormente, se procede a seleccionar los datos de interés y a generar nuevas
características que puedan resultar interesantes para el análisis posterior.

## 2.1 Exploración de los datos (screening)

A continuación procedemos a cargar el __dataset__, sin __factors__, para evitar tratar los nombres de los pasajeros como tales.

```{r echo=TRUE, message=FALSE, warning=FALSE}
ds <- read.csv(file = "train.csv", header=TRUE, stringsAsFactors=FALSE)
str(ds)
```
Como se puede observar, el __dataset__ contiene 891 registros y 12 atributos. Tenemos las variables cuantitativas PassengerId, Survived, Pclass, Age, SibSp, Parch y Fare, todas tratadas como int o num. También están las variables cualitativas Ticket, PClass, Sex y  Cabin, cargadas como cadena de caracteres.

Para más claridad de los datos, procedemos a realizar las siguientes transformaciones:
- Transformamos el campo dicotómico Survived a Yes(1) y Not(0).
- Transformamos el campo cualitativo categórico Embarked a un factor con 3 posibles valores, cada uno con el nombre del puerto.
- Transformamos el campo dicotómico Sex en vez de cadena.

```{r echo=TRUE, message=FALSE, warning=FALSE}
ds$Survived <- factor(ds$Survived, levels=sort(c(0,1)), labels = c("Not", "Yes"))
ds$Embarked <- factor(ds$Embarked, levels=sort(c("C", "Q", "S")), labels = c("Cherbourg", "Queenstown", "Southampton"))
ds$Sex <- factor(ds$Sex)
str(ds)
```

Para hacernos una idea de las características, vamos a mostrar las estadístcas básicas:

```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(ds)
```
La información más relevante es:

- **Survived**: Hay más gente que falleció que sobrevivió.
- **Pclass**: Lo más común es tercera clases (Median).
- **Sex**: En el barco viajaban el doble de hombres que de mujeres.
- **age**: especifica la edad en años. Podemos ver que el mínimo es 0.42 años, así que se contemplan bebés.
La persona más anciana tenía 80 años y la media de edad estaba en torno a los 30 años.
- **SibSp**: Lo más común es ir sin hermanos ni mujer.
- **Parch**: Es menos común todavía ir con descendientes o ascendientes.
- **Fare**: La media del precio del billete es 32.2 y la mediana 14. Esto indica que hay mucha disparidad de precios, siendo
el máximo 512.
- **Embarked**: La mayoría embarcaron de Southamption, luego de Cherbourg y unos pocos de Queenstown.

Por último, hacemos una inspección visual de los campos que menos sabemos sobre ellos: Ticket y Cabin.

La codificación del billete (Ticket) parece que sigue diferentes patrones y además, hay viajeros que comparten
el ticket ya que si los ordenamos, podemos comprobar que estos se repiten:

```{r echo=TRUE, message=FALSE, warning=FALSE}
sort(ds$Ticket)[1:10]
```
Si comprobamos los campos únicos, vemos que pasa de 891 a 681 valores diferentes.

```{r echo=TRUE, message=FALSE, warning=FALSE}
length(distinct(ds, Ticket)$Ticket)
```
Además, el que un ticket se repita no depende de su tipo:

```{r echo=TRUE, message=FALSE, warning=FALSE}
aux <- count(ds, Ticket)
aux[order(aux[,2], decreasing = TRUE), ][1:10, ]
```

Suponemos que se puede comprar un mismo billete para varias personas. ¿Compartirán el camarote? ¿Serán familia?
Veamos los datos de estos 10.

Ticket 1601:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "1601", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```

Ticket 347082:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "347082", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```

Ticket CA. 2343:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "CA. 2343", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```
Ticket 347088:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "347088", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```
Ticket 3101295:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "3101295", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```
Ticket 347088:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "347088", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```
Ticket CA 2144:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "CA 2144", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```
Ticket 382652:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "382652", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```

Ticket S.O.C. 14879:

```{r echo=TRUE, message=FALSE, warning=FALSE}
select(ds[ds$Ticket == "S.O.C. 14879", ], Name, Pclass, Fare, Cabin, Embarked, Sex, Age, SibSp, Parch)
```


```{r echo=TRUE, message=FALSE, warning=FALSE}
sort(distinct(ds, Ticket)$Ticket)
```

## 2.2 Selección y creación de características

__Los atributos PassengerId y Name no serán objeto de análisis__. 

 Nótese que Cabin es susceptible de ser dividida en letra y número.
 
 
## 2.1 Carga de los datos y selección



## 2.2 Transformación de los datos


A continuación analizamos cada uno de los distintos atributos:

```{r}

summary(ds)
```

Vemos que los campos Age y Embarked tienen 177 y 2 valores nulos, respectivamente. Como no tiene sentido interpretarlos como 0 años o ningún puerto, sustituimos estos campos por la mediana para que afecten en la medida de lo posible al análisis.

```{r}

age_median <- median(ds$Age, na.rm = TRUE)

ds[, 'Age'][is.na(ds[,'Age'])] <- age_median

embarked_most_frequent <-  levels(ds$Embarked)[which.max(ds$Embarked)]

ds[, 'Embarked'][is.na(ds[,'Embarked'])] <- embarked_most_frequent

summary(ds)


```


```{r}
#Visualización de variables cuantitativas

#Age
gAge1 <- ggplot(ds, aes(x=Age)) + geom_boxplot()

gAge2 <- ggplot(ds, aes(x=Age)) + geom_histogram(bins=20)

#SibSp

gSibSp1 <- ggplot(ds, aes(x=SibSp)) + geom_boxplot()

gSibSp2 <- ggplot(ds, aes(x=SibSp)) + geom_histogram(bins=20)

#Parch

gParch1 <- ggplot(ds, aes(x=Parch)) + geom_boxplot()

gParch2 <- ggplot(ds, aes(x=Parch)) + geom_histogram(bins=20)


#Fare

gFare1 <- ggplot(ds, aes(x=Fare)) + geom_boxplot()

gFare2 <- ggplot(ds, aes(x=Fare)) + geom_histogram(bins=20)


```


```{r}

grid.arrange(gAge1,gAge2,nrow=1)

grid.arrange(gSibSp1,gSibSp2,nrow=1)

grid.arrange(gParch1,gParch2,nrow=1)

grid.arrange(gFare1,gFare2,nrow=1)

```

```{r}

#Visualizacion de variables cuantitativas

#Survived
sumSurvived <- summarize( group_by(ds, Survived), n=length(Survived), Fare=mean(Fare))

gSurvived1 <- ggplot( sumSurvived, aes(x="", y=n, fill=Survived)) +
geom_bar(width = 1, stat = "identity") +
coord_polar("y", start=0) + ggtitle("Survived")

#PClass and Survived
sumPClass <- summarize( group_by(ds, Pclass), n=length(Pclass), Survived=mean(Survived))

gPClass1 <- ggplot( sumPClass, aes(x="", y=n, fill=Pclass)) +
geom_bar(width = 1, stat = "identity") +
coord_polar("y", start=0) + ggtitle("PClass")

gPClass2 <- ds %>%
  group_by(Survived, Pclass) %>%
  tally() %>%
  group_by(Survived) %>%
  mutate(x = n / sum(n)) %>%
  ggplot() +
    geom_col(aes(
      x = factor(Survived),
      y = x,
      fill = factor(Pclass)
      ), position = "stack")

#Sex and Survived
sumSex <- summarize( group_by(ds, Sex), n=length(Sex), Survived=mean(Survived))

gSex1 <- ggplot( sumSex, aes(x="", y=n, fill=Sex)) +
geom_bar(width = 1, stat = "identity") +
coord_polar("y", start=0) + ggtitle("Sex")

gSex2 <- ds %>%
  group_by(Survived, Sex) %>%
  tally() %>%
  group_by(Survived) %>%
  mutate(x = n / sum(n)) %>%
  ggplot() +
    geom_col(aes(
      x = factor(Survived),
      y = x,
      fill = factor(Sex)
      ), position = "stack")

#Embarked and Survived
sumEmbarked <- summarize( group_by(ds, Embarked), n=length(Embarked))

gEmbarked1 <- ggplot( sumEmbarked, aes(x="", y=n, fill=Embarked)) +
geom_bar(width = 1, stat = "identity") +
coord_polar("y", start=0) + ggtitle("Embarked")


gEmbarked2 <- ds %>%
  group_by(Survived, Embarked) %>%
  tally() %>%
  group_by(Survived) %>%
  mutate(x = n / sum(n)) %>%
  ggplot() +
    geom_col(aes(
      x = factor(Embarked),
      y = x,
      fill = factor(Survived)
      ), position = "stack")

```

```{r}

grid.arrange(gSurvived1, nrow=2)

grid.arrange(gPClass1,gPClass2, nrow=1)

grid.arrange(gSex1, gSex2, nrow=1)

grid.arrange(gEmbarked1, gEmbarked2, nrow=1)

```

#2.3 Descipción estadística descriptiva

TODO: Describir cómo se distribuyen los datos y como podría saltar a la vista correlaciones. Da idea del ejercicio 4.

#3. Limpieza de datos

## 3.1  Elementos vacíos

TODO: En el ejercicio 1 se ha pintado  el campo Age y el campo Embarked ya sin elementos vacíos. Traer aqui y pintar de nuevo, con un summary para demostrar que han desaparecido.


## 3.2 Identificación y tratamiento de valores extremos.


TODO: Explicar que hay valores extremos pero no podemos suponer que sean incorrectos (por ejemplo gente que tiene 8 hermanos o un billete que cuesta 500$). Poner ejemplos...


# 4. Análisis de los datos

## 4.1 Selección de los grupos de datos que se quieen analizar / comparar.

Posibles grupos que puedan ser interesantes a la hora de averiguar si la probabilidad de sobrevivir era mucho más alta según el grupo.

```{r}
  
# Por clase

# Gente que viajaba sola vs gente con familia

# Por sexo

males_passengers <- ds[ds$Sex == "male",] 
females_passengers <- ds[ds$Sex == "female",]


# Por edad, niños por debajo de los 16 años

children_passengers <- ds[ds$Age <= 16,] 
not_children__passengers <- ds[ds$Age > 16,] 
  

```

## 4.2. Comprobación de la normalidad y homogeneidad de la varianza

```{r}

#Normalidad para el campo Age
ks.test(ds$Age, pnorm, mean(ds$Age), sd(ds$Age))

shapiro.test(ds$Age)


```

Nos dan que la edad no sigue una distribucion normal, pero por el teorema del limite central.... podemos suponerlo.

```{r}

library(car)

levtest<- function(x, y) {
  leveneTest(dv~gr, data = rbind(data.frame(dv=x, gr='gr1'),
                               data.frame(dv=y, gr='gr2')), center='mean')
}

flignertest<- function(x, y) {
  fligner.test(dv~gr, data = rbind(data.frame(dv=x, gr='gr1'),
                               data.frame(dv=y, gr='gr2')))
}

levtest(children_passengers$Age, not_children__passengers$Age)


flignertest(children_passengers$Age, not_children__passengers$Age)


var.test(children_passengers$Age, not_children__passengers$Age)


```


#4.3. Aplicación de pruebas estadísticas para comparar los grupos de datos
Ambos grupos no tienen la misma varianza.

```{r}

  #Hay correlacion

  wilcox.test(Age ~ Survived, data = ds)

  wilcox.test(Age ~ Survived, data = children_passengers)
  wilcox.test(Age ~ Survived, data = not_children__passengers)
  
  
  wilcox.test(children_passengers$Age, not_children__passengers$Age, alternative = "two.sided")
  wilcox.test(children_passengers$Age, not_children__passengers$Age, alternative = "greater")
  wilcox.test(children_passengers$Age, not_children__passengers$Age, alternative = "less")

  summary(children_passengers)
  summary(not_children__passengers)
  

```

Los menores de 16 años tuvieron mucha más oportunidad de salvarse que los mayores de 16 años. La edad es un factor determinante. Pintarlo en el apartado 5.
